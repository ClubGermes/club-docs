# Поток авторизации (Auth Flow)

Система использует кастомную схему авторизации на основе сессий с хранением в Redis.

## Общая схема

1.  **Клиент** (Mobile App) отправляет номер телефона.
2.  **SMS-шлюз** отправляет код подтверждения.
3.  **Клиент** отправляет код.
4.  **Backend** выдает `session_id`.
5.  Все последующие запросы подписываются заголовком `Authorization: Bearer <session_id>`.

## Детальный разбор (Gateway Pattern)

Центральной точкой входа для мобильного приложения является сервис **`club-gateway-m`**.

### 1. Валидация токена
При каждом запросе Gateway проверяет наличие и валидность сессии.

*   **Где:** Middleware в `club-gateway-m`.
*   **Хранилище:** Redis.
*   **Ключ:** `session:<token>`.

### 2. Обогащение контекста (Context Injection)
Если токен валиден, Gateway извлекает `user_id` из сессии Redis и добавляет его в заголовки проксируемого запроса:

```http
X-User-ID: 10050
```

Это позволяет внутренним микросервисам (например, `club-api` или `club-users`) доверять пришедшему `user_id`, не проверяя токен повторно.

### 3. Межсервисная безопасность
Для защиты внутренних эндпоинтов от прямого доступа извне используется механизм **API Key**. Гейтвей подписывает запросы специальным ключом, который проверяется микросервисами.

> **Примечание:** В режиме локальной разработки (`make dev`) сетевой доступ к микросервисам открыт, но в продакшене они должны быть закрыты фаерволом.
