# Авторизация и Регистрация

Модуль отвечает за аутентификацию пользователей, регистрацию новых членов клуба и привязку устройства для Push-уведомлений.

## Экран Входа (Login)

Экран реализован в компоненте `src/views/Login/Login.svelte`. Поддерживает три стратегии входа, переключаемые через табы.

### 1. Вход по номеру телефона / Email
Основной сценарий для пользователей без пароля.

| Шаг 1: Ввод данных | Шаг 2: Ввод кода |
|---|---|
| ![Login Phone](mobile/auth/auth-login-step1-phone.png) { width="200" } | *(Скриншот ввода кода)* |

1.  Пользователь вводит номер или Email.
2.  Нажимает **"Получить код"**.
3.  Клиент вызывает `POST /login/mobile` (или `/email`).
4.  Сервер отправляет OTP (One Time Password).
5.  Пользователь вводит код, клиент вызывает `POST /login/mobile/validate`.

### 2. Вход по паролю
Используется администраторами или пользователями, установившими пароль в профиле.

![Login Password](mobile/auth/auth-login-step1-password.png) { width="200" }

*   Вызывается метод `POST /login`.
*   Токен доступа сохраняется в `localStorage` с ключом `___:token`.

## Экран Регистрации

Реализован в `src/views/Registration/Registration.svelte`. Это единая длинная форма для первичного сбора данных о резиденте.

![Registration Screen](mobile/auth/auth-registration-form.png) { width="200" }

**Особенности процесса:**
1.  **Двойная верификация:** Пользователь должен подтвердить и Email, и Телефон одновременно.
2.  Кнопка **"Получить коды"** отправляет запрос `POST /new/validate`, который инициирует рассылку OTP на оба канала связи.
3.  После ввода обоих кодов разблокируется кнопка **"Зарегистрироваться"** (`POST /new/register`).

## Push-уведомления

При первом запуске приложение запрашивает права на отправку уведомлений.

![Push Permission](mobile/auth/auth-push-notification-permission-prompt.png) { width="200" }

*   **Логика:** `src/App.svelte` -> `setupFCM()`.
*   **Регистрация:** FCM-токен устройства отправляется на бэкенд через `POST /register/device`.
*   **Обработка:** При нажатии на пуш приложение использует `router.go()` для перехода к соответствующему разделу (например, к событию).

## Технические детали и Долг

*   **Валидация:** Используются простые Regex для проверки телефона (`[\d\s\(\)\-]{10,20}`). Это позволяет вводить номера в разных форматах, но может пропускать некорректные данные.
*   **Безопасность:** Токены хранятся в LocalStorage (WebView), а не в SecureStore устройства.
*   **Хардкод:** В коде регистрации есть поля (например, `company`, `position`), которые обязательны, но валидация на клиенте может рассинхронизироваться с бэкендом.
