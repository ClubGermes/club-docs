# Авторизация и Регистрация

Модуль отвечает за аутентификацию пользователей, регистрацию новых членов клуба и привязку устройства для Push-уведомлений.

## Экран Входа (Login)

Экран реализован в компоненте `src/views/Login/Login.svelte`. Поддерживает три стратегии входа, переключаемые через табы.

### 1. Вход по номеру телефона / Email
Основной сценарий для пользователей без пароля.

**Шаг 1: Ввод данных**

![Login Phone](auth-login-step1-phone.png) { width="200" }

**Шаг 2: Ввод кода**
*(Скриншот ввода кода)*

1.  Пользователь вводит номер или Email.
2.  Нажимает **"Получить код"**.
3.  Клиент вызывает `POST /login/mobile` (или `/email`).
4.  Сервер отправляет OTP (One Time Password).
5.  Пользователь вводит код, клиент вызывает `POST /login/mobile/validate`.

### 2. Вход по паролю
Используется администраторами или пользователями, установившими пароль в профиле.

![Login Password](auth-login-step1-password.png) { width="200" }

*   Вызывается метод `POST /login`.
*   Токен доступа сохраняется в `localStorage` с ключом `___:token`.

## Пост-авторизационная логика (Post-Login)

Сразу после успешного получения токена (в `src/helpers/auth.ts`) происходят следующие действия:

1.  **Сохранение состояния:** Данные пользователя (`_user` из ответа) записываются в глобальный Svelte Store (`user.push(data._user)`).
2.  **WebSocket:** Инициализируется постоянное соединение через `websocket.establish()`. Это критично для получения уведомлений в реальном времени.
3.  **Редирект:** Компонент `src/App.svelte` реактивно отслеживает изменение `user.id`. Как только ID становится доступным, происходит перенаправление:
    *   Если есть сохраненный маршрут (`onLogin`), пользователь переходит туда.
    *   Иначе — на главный экран (`/`).

## Экран Регистрации

Реализован в `src/views/Registration/Registration.svelte`. Это единая форма для создания полноценного бизнес-профиля резидента.

![Registration Screen](auth-registration-form.png) { width="200" }

**Отправляемые данные (`POST /new/register`):**
Регистрация ориентирована на B2B сегмент, поэтому помимо стандартных данных, собирается информация о бизнесе:
*   `name` — ФИО.
*   `company` — Название компании.
*   `position` — Должность.
*   `annual` — Годовой оборот.
*   `employees` — Количество сотрудников.
*   `catalog` — Отрасли деятельности.
*   `interests` — Профессиональные интересы.

**Особенности процесса:**
1.  **Двойная верификация:** Пользователь должен подтвердить и Email, и Телефон одновременно.
2.  Кнопка **"Получить коды"** отправляет запрос `POST /new/validate`, который инициирует рассылку OTP на оба канала связи.
3.  После ввода обоих кодов разблокируется кнопка **"Зарегистрироваться"**.

## Push-уведомления

При первом запуске приложение запрашивает права на отправку уведомлений.

![Push Permission](auth-push-notification-permission-prompt.png) { width="200" }

*   **Логика:** `src/App.svelte` -> `setupFCM()`.
*   **Регистрация:** FCM-токен устройства отправляется на бэкенд через `POST /register/device`.
*   **Обработка:** При нажатии на пуш приложение использует `router.go()` для перехода к соответствующему разделу (например, к событию).

## Технические детали и Долг

### Обработка ошибок
Система использует централизованный механизм обработки ошибок API.
*   Бэкенд возвращает ошибки в поле `_alert`.
*   Транспортный слой (`src/helpers/request.ts`) перехватывает это поле.
*   Событие передается в шину `alertsPush`.
*   Компонент `src/components/Alerts` отображает ошибку пользователю в виде всплывающего уведомления (Toast) в верхней части экрана.

### Известные проблемы
*   **Валидация:** Используются простые Regex для проверки телефона (`[\d\s\(\)\-]{10,20}`). Это позволяет вводить номера в разных форматах, но может пропускать некорректные данные.
*   **Безопасность:** Токены хранятся в LocalStorage (WebView), а не в SecureStore устройства.
*   **Хардкод:** Обязательность полей "Компания" и "Оборот" зашита в код регистрации, что может требовать синхронизации при изменении бизнес-логики на бэкенде.