# Развертывание (Deployment)

Процесс доставки кода на серверы (CI/CD) построен на базе **Bitbucket Pipelines**.

## Инфраструктура (Yandex Cloud)

*   **Production Environment:** Виртуальные машины (VM) в Yandex Cloud.
*   **Database:** Yandex Managed PostgreSQL (кластер).
*   **Container Registry:** Yandex Container Registry (для хранения Docker-образов).

## Пайплайн (Pipeline Overview)

Процесс деплоя автоматизирован в `bitbucket-pipelines.yml`.

### Основные этапы:

1.  **Build & Test:**
    *   Сборка Docker-образов для микросервисов.
    *   Запуск линтеров (Ruff, Mypy) и тестов (Pytest).
2.  **Push:**
    *   Собранные образы пушатся в Container Registry с тегом коммита.
3.  **Deploy:**
    *   Пайплайн подключается к продакшн-серверу по SSH.
    *   Обновляет `docker-compose.yml` (или переменные окружения).
    *   Выполняет `docker-compose pull` и `docker-compose up -d`.

### Особенности Legacy
Для старого сервиса `club-api` деплой может происходить по упрощенной схеме: `git pull` прямо на сервере и перезапуск systemd юнитов или docker-контейнеров.

## Управление секретами

Переменные окружения (`DB_PASSWORD`, `API_KEY`, `JWT_SECRET`) **не хранятся в репозитории**.

*   **В CI/CD:** Настроены как Repository Variables в интерфейсе Bitbucket.
*   **На сервере (Runtime):** Хранятся в файле `.env`, который не попадает в Git. Этот файл монтируется в контейнеры при запуске.

## Логирование и Мониторинг

В проекте **не используются** внешние системы сбора ошибок и аналитики (Sentry, Firebase Analytics, New Relic и т.д.).

### Просмотр логов
Единственным источником информации о проблемах являются системные логи на сервере.
В продакшене логи приложений пишутся в стандартный вывод (`stdout/stderr`).

**Просмотр логов на сервере:**
```bash
# Следить за логами конкретного сервиса (последние 100 строк)
docker logs -f --tail 100 club-events_app

# Логи всех сервисов
docker-compose logs -f --tail 50
```

### Отладка ошибок (Crash Reporting)
Так как автоматического репортинга нет, при возникновении ошибок у пользователей (например, "белый экран" в мобильном приложении или 500 ошибка на бэкенде), необходимо:
1. Запросить у пользователя время возникновения ошибки.
2. Вручную искать соответствующие записи в логах Docker на сервере.
3. Проверять логи Nginx (если запрос не дошел до бэкенда).
